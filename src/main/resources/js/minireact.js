(function(i,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(i=typeof globalThis<"u"?globalThis:i||self,h(i.Dong={}))})(this,function(i){"use strict";function h(e,t,...n){return console.log("createElement生成的原始虚拟DOM如下"),e==null&&console.error("ERROR"),console.log({type:e,props:{...t,children:n.map(o=>typeof o=="object"?o:g(o))}}),{type:e,props:{...t,children:n.map(o=>typeof o=="object"?o:g(o))}}}function g(e){return{type:"TEXT_ELEMENT",props:{nodeValue:e,children:[]}}}let d=null,u=null,p=null,E=[],c=null,a=0;function C(e,t){u={dom:t,props:{children:[e]},alternate:p},d=u,console.log("render阶段结束,生成的wipRoot如下"),console.log(u)}requestIdleCallback(m);function m(e){let t=!1;for(;d&&!t;)d=N(d),t=e.timeRemaining()<1,t&&console.warn("空闲时间耗尽，生成虚拟 DOM 被打断，等待下次调度以便从上次中断的地方继续");!d&&u&&W(),d&&requestIdleCallback(m)}function N(e){if(c=e,typeof e.type=="function"&&(a=0,e.hooks=[]),V(e),e.child)return e.child;let t=e;for(;t;){if(t.sibling)return t.sibling;t=t.return}return null}function V(e){var t;if(typeof e.type=="function"){const n=e.type(e.props);Array.isArray(n)?k(e,n):k(e,[n])}else{e.dom||(e.dom=_(e));const n=((t=e.props)==null?void 0:t.children)||[];k(e,n)}}function H(e,t){if(e===t)return!0;const n=Object.keys(e),o=Object.keys(t);if(n.length!==o.length)return!1;for(let l of n){const s=e[l],r=t[l];if(l==="children"){if(Array.isArray(s)&&Array.isArray(r)){if(s.length!==r.length)return!1;if(s.length>1){for(let f=0;f<s.length;f++)if(s[f].type!==r[f].type)return!1}else if(s.length===1&&(Array.isArray(s[0])&&console.error(s[0]),!Array.isArray(s[0])))return s[0].props.nodeValue===r[0].props.nodeValue}}else{if(l.startsWith("on")&&typeof s=="function"&&typeof r=="function")return s===r;if(!D(s,r))return!1}}return!0}const D=(e,t)=>{if(e===t)return!0;if(typeof e!="object"||typeof t!="object"||e==null||t==null)return!1;const n=Object.keys(e),o=Object.keys(t);if(n.length!==o.length)return!1;for(let l of n)if(!o.includes(l)||!D(e[l],t[l]))return!1;return!0};function I(e,t){return e===t?!0:e.type!==t.type?!1:H(e.props,t.props)}function k(e,t){let n=0,o=null,l=e.alternate&&e.alternate.child,s=t.flat();for(;n<s.length||l!=null;){let r=s[n];typeof r!="object"&&(r=g(r));let f=null;l&&r&&r.type===l.type?!I(r,l)?(console.warn("节点与上一课fiber树不一致,需要进行节点更新,更新的fiber如下"),f={type:l.type,props:r.props,dom:l.dom,return:e,alternate:l,effectTag:"UPDATE",shouldHighlight:!0},console.log(f),console.log(l)):f={type:l.type,props:r.props,dom:l.dom,return:e,alternate:l,effectTag:"",shouldHighlight:!1}:(r&&(f={type:r.type,props:r.props,dom:null,return:e,alternate:null,effectTag:"PLACEMENT",shouldHighlight:!0}),l&&(l.effectTag="DELETION",E.push(l))),l&&(l=l.sibling),n===0?e.child=f:o&&(o.sibling=f),console.log("协调后的虚拟DOM如下"),o=f,console.log(o),n++}}function W(){E.forEach(y),E=[],y(u.child),T(u.child),p=u,u=null}function T(e){e&&(e.hooks&&e.hooks.forEach(t=>{t.effect&&t.hasEffect&&(t.cleanup=t.effect(),t.hasEffect=!1)}),T(e.child),T(e.sibling))}function y(e){if(!e)return;let t=e.return;for(;!t.dom;)t=t.return;const n=t.dom;if(e.effectTag==="PLACEMENT"&&e.dom!=null)n.appendChild(e.dom),n.classList.add("fade-in-border"),setTimeout(()=>{n.classList.remove("fade-in-border")},3e3),console.log("节点插入");else if(e.effectTag==="UPDATE"&&e.dom!=null)X(e.dom,e.alternate.props,e.props);else if(e.effectTag==="DELETION"){A(e,n),console.log("节点删除");return}y(e.child),y(e.sibling)}function A(e,t){e&&(e.dom?t.removeChild(e.dom):A(e.child,t),A(e.sibling,t))}function _(e){let t;e.type=="TEXT_ELEMENT"?t=document.createTextNode(e.props.nodeValue):t=document.createElement(e.type==null?"div":e.type);for(const n in e.props)B(t,n,e.props[n]);return console.log("真实DOM如下:"),console.log(t),t}function O(e,t){return typeof t=="function"&&e.startsWith("on")}function U(e,t){return e=="style"&&typeof t=="object"}function L(e,t){return typeof t!="object"&&typeof t!="function"}const B=(e,t,n)=>{if(t!=="children")if(t==="nodeValue")e.textContent=n;else if(O(t,n)){const o=t.slice(2).toLowerCase();e.addEventListener(o,n)}else U(t,n)?Object.assign(e.style,n):t==="ref"&&typeof n=="object"?n.current=e:L(t,n)&&e.setAttribute(t,n)};function X(e,t,n){if(e instanceof Text){t.nodeValue!==n.nodeValue&&(e.nodeValue=n.nodeValue);return}Object.entries(t).filter(([o,l])=>O(o,l)).forEach(([o,l])=>{const s=o.toLowerCase().substring(2);e.removeEventListener(s,l)}),Object.entries(n).filter(([o,l])=>O(o,l)).forEach(([o,l])=>{const s=o.toLowerCase().substring(2);e.addEventListener(s,l)}),Object.keys(t).filter(o=>L(o,t[o])).forEach(o=>{o in n||e.removeAttribute(o)}),Object.keys(n).filter(o=>L(o,n[o])).forEach(o=>{t[o]!==n[o]&&e.setAttribute(o,n[o])}),t.style&&Object.keys(t.style).forEach(o=>{(!n.style||!(o in n.style))&&(e.style[o]="")}),n.style&&Object.keys(n.style).forEach(o=>{(!t.style||t.style[o]!==n.style[o])&&(e.style[o]=n.style[o])}),e.classList.add("fade-in-border"),setTimeout(()=>{e.classList.remove("fade-in-border")},3e3)}function j(e){const t=c.alternate&&c.alternate.hooks?c.alternate.hooks[a]:null,n={state:t?t.state:e,queue:t?t.queue:[]};n.queue.forEach(l=>{console.log("处理hooks中"),console.log("action",l),n.state=l(n.state)}),n.queue.length=0;const o=l=>{console.log("setState调用"),n.queue.push(typeof l=="function"?l:()=>l),u={dom:p.dom,props:p.props,alternate:p},d=u,console.log("调用useState造成重新渲染"),requestIdleCallback(m)};return c.hooks.push(n),a++,[n.state,o]}function w(e,t){const n=c.alternate&&c.alternate.hooks?c.alternate.hooks[a]:null;let o;n&&t?o=t.some((s,r)=>!Object.is(s,n.deps[r])):o=!0;const l={deps:t,effect:e,cleanup:n?n.cleanup:null};if(o){l.cleanup&&l.cleanup();const s=e();l.cleanup=typeof s=="function"?s:null}c.hooks.push(l),a++}function R(e,t){const n=c.alternate&&c.alternate.hooks?c.alternate.hooks[a]:null;let o;n&&t?o=t.some((s,r)=>!Object.is(s,n.deps[r])):o=!0;const l={callback:o?e:n.callback,deps:t};return c.hooks.push(l),a++,l.callback}function S(){const e=new Set;function t(n,o){if(n==="dom"||n==="alternate")return"[忽略]";if(n==="props"&&typeof o=="object"&&o!==null){const l={};return Object.keys(o).forEach(s=>{(s==="children"||typeof o[s]!="function")&&(l[s]=o[s])}),l}if(typeof o=="object"&&o!==null){if(e.has(o))return"[循环引用]";e.add(o)}return o}return[JSON.stringify(u,t,2),u]}function q(e){const n=(c.alternate&&c.alternate.hooks?c.alternate.hooks[a]:null)||{current:e};return c.hooks.push(n),a++,n}const M={createElement:h,render:C,useState:j,useEffect:w,useAware:S,useCallBack:R,useRef:q};typeof window<"u"&&(window.Dong=M),i.default=M,i.render=C,i.useAware=S,i.useCallBack=R,i.useEffect=w,i.useRef=q,i.useState=j,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
