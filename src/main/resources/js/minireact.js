(function(u,d){typeof exports=="object"&&typeof module<"u"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(u=typeof globalThis<"u"?globalThis:u||self,d(u.Dong={}))})(this,function(u){"use strict";function d(e,t,...n){return console.log("createElement生成的原始虚拟DOM如下"),e==null&&console.error("ERROR"),console.log({type:e,props:{...t,children:n.map(o=>typeof o=="object"?o:g(o))}}),{type:e,props:{...t,children:n.map(o=>typeof o=="object"?o:g(o))}}}function g(e){return{type:"TEXT_ELEMENT",props:{nodeValue:e,children:[]}}}let a=null,r=null,p=null,E=[],f=null,y=0;function k(e,t){r={dom:t,props:{children:[e]},alternate:p},a=r}requestIdleCallback(m);function m(e){let t=!1;for(;a&&!t;)a=M(a),t=e.timeRemaining()<1,t&&console.error("空闲时间耗尽，生成虚拟 DOM 被打断，等待下次调度以便从上次中断的地方继续");!a&&r&&R(),requestIdleCallback(m)}function M(e){if(f=e,typeof e.type=="function"&&(y=0,e.hooks=[]),N(e),e.child)return e.child;let t=e;for(;t;){if(t.sibling)return t.sibling;t=t.return}return null}function N(e){var t;if(typeof e.type=="function"){const n=e.type(e.props);Array.isArray(n)?T(e,n):T(e,[n])}else{e.dom||(e.dom=I(e));const n=((t=e.props)==null?void 0:t.children)||[];T(e,n)}}function q(e,t){if(e===t)return!0;const n=Object.keys(e),o=Object.keys(t);if(n.length!==o.length)return!1;for(let l of n){const s=e[l],c=t[l];if(l==="children"){if(Array.isArray(s)&&Array.isArray(c)){if(s.length!==c.length)return!1;if(s.length>1){for(let i=0;i<s.length;i++)if(s[i].type!==c[i].type)return!1}else if(s.length===1&&!Array.isArray(s[0]))return s[0].props.nodeValue===c[0].props.nodeValue}}else{if(l.startsWith("on")&&typeof s=="function"&&typeof c=="function")continue;if(s!==c)return!1}}return!0}function V(e,t){return e===t?!0:e.type!==t.type?!1:q(e.props,t.props)}function T(e,t){let n=0,o=null,l=e.alternate&&e.alternate.child,s=t.flat();for(;n<s.length||l!=null;){let c=s[n];typeof c!="object"&&(c=g(c));let i=null;l&&c&&c.type===l.type?!V(c,l)?(console.error("节点与上一课fiber树不一致,需要进行节点更新,更新的fiber如下"),i={type:l.type,props:c.props,dom:l.dom,return:e,alternate:l,effectTag:"UPDATE"},alert("节点与上一课fiber树不一致,需要进行节点更新："+JSON.stringify(i.props)),console.log(i),console.log(l)):i={type:l.type,props:c.props,dom:l.dom,return:e,alternate:l,effectTag:""}:(c&&(i={type:c.type,props:c.props,dom:null,return:e,alternate:null,effectTag:"PLACEMENT"}),l&&(l.effectTag="DELETION",E.push(l))),l&&(l=l.sibling),n===0?e.child=i:o&&(o.sibling=i),console.log("协调后的虚拟DOM如下"),o=i,console.log(o),n++}}function R(){E.forEach(h),E=[],h(r.child),O(r.child),p=r,r=null}function O(e){e&&(e.hooks&&e.hooks.forEach(t=>{t.effect&&t.hasEffect&&(t.cleanup=t.effect(),t.hasEffect=!1)}),O(e.child),O(e.sibling))}function h(e){if(!e)return;let t=e.return;for(;!t.dom;)t=t.return;const n=t.dom;if(e.effectTag==="PLACEMENT"&&e.dom!=null)n.appendChild(e.dom),console.log("节点插入");else if(e.effectTag==="UPDATE"&&e.dom!=null)U(e.dom,e.alternate.props,e.props);else if(e.effectTag==="DELETION"){A(e,n),console.log("节点删除");return}h(e.child),h(e.sibling)}function A(e,t){e&&(e.dom?t.removeChild(e.dom):A(e.child,t),A(e.sibling,t))}function I(e){let t;e.type=="TEXT_ELEMENT"?t=document.createTextNode(e.props.nodeValue):t=document.createElement(e.type==null?"div":e.type);for(const n in e.props)_(t,n,e.props[n]);return console.log("真实DOM如下:"),console.log(t),t}function j(e,t){return typeof t=="function"&&e.startsWith("on")}function W(e,t){return e=="style"&&typeof t=="object"}function D(e,t){return typeof t!="object"&&typeof t!="function"}const _=(e,t,n)=>{if(t!=="children")if(t==="nodeValue")e.textContent=n;else if(j(t,n)){const o=t.slice(2).toLowerCase();e.addEventListener(o,n)}else W(t,n)?Object.assign(e.style,n):D(t,n)&&e.setAttribute(t,n)};function U(e,t,n){if(e instanceof Text){t.nodeValue!==n.nodeValue&&(e.nodeValue=n.nodeValue);return}Object.keys(t).filter(j).forEach(o=>{const l=o.toLowerCase().substring(2);e.removeEventListener(l,t[o])}),Object.keys(n).filter(j).forEach(o=>{const l=o.toLowerCase().substring(2);e.addEventListener(l,n[o])}),Object.keys(t).filter(D).forEach(o=>{o in n||e.removeAttribute(o)}),t.style&&Object.keys(t.style).forEach(o=>{(!n.style||!(o in n.style))&&(e.style[o]="")}),n.style&&Object.keys(n.style).forEach(o=>{(!t.style||t.style[o]!==n.style[o])&&(e.style[o]=n.style[o])}),n.style&&Object.keys(n.style).forEach(o=>{(!t.style||t.style[o]!==n.style[o])&&(e.style[o]=n.style[o])})}function L(e){const t=f.alternate&&f.alternate.hooks?f.alternate.hooks[y]:null,n={state:t?t.state:e,queue:t?t.queue:[]};n.queue.forEach(l=>{console.log("处理hooks中"),console.log("action",l),n.state=l(n.state)}),n.queue.length=0;const o=l=>{console.log("setState调用"),n.queue.push(typeof l=="function"?l:()=>l),r={dom:p.dom,props:p.props,alternate:p},a=r,console.log("useState造成重新渲染"),requestIdleCallback(m)};return f.hooks.push(n),y++,[n.state,o]}function C(e,t){const n=f.alternate&&f.alternate.hooks?f.alternate.hooks[y]:null;let o;n&&t?o=t.some((s,c)=>!Object.is(s,n.deps[c])):o=!0;const l={deps:t,effect:e,cleanup:n?n.cleanup:null};if(o){l.cleanup&&l.cleanup();const s=e();l.cleanup=typeof s=="function"?s:null}f.hooks.push(l),y++}function S(){const e=new Set;function t(n,o){if(n==="dom"||n==="alternate")return"[忽略]";if(n==="props"&&typeof o=="object"&&o!==null){const l={};return Object.keys(o).forEach(s=>{(s==="children"||typeof o[s]!="function")&&(l[s]=o[s])}),l}if(typeof o=="object"&&o!==null){if(e.has(o))return"[循环引用]";e.add(o)}return o}return[JSON.stringify(r,t,2),r]}const w={createElement:d,render:k,useState:L,useEffect:C,useAware:S};typeof window<"u"&&(window.Dong=w),u.default=w,u.render=k,u.useAware=S,u.useEffect=C,u.useState=L,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
